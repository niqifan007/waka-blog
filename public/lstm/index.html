<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>使用LSTM对航班延误进行预测 - waka&#39;s blog</title><meta name="author" content="waka">
<meta name="author-link" content="">
<meta name="description" content="使用LSTM预测航班延误
介绍
航班延误是航空公司和乘客都不愿意面对的问题。在某些情况下，延误可能会导致航空公司的巨额损失，也会影响旅客的日常生活。因此，预测航班延误对于航空公司和旅客来说都非常重要。在本文中，我们将介绍如何使用LSTM来预测航班延误。
数据收集和预处理
要预测航班延误，我们需要收集航班数据。我们可以从航空公司、机场网站或第三方数据提供商那里获取数据。在本文中，我们使用开放数据集“航班延误和取消数据”来预测航班延误。在收集数据后，我们需要对数据进行预处理。这包括清洗数据、处理缺失值和异常值等。我们还需要将数据转换为适合LSTM模型的形式。
这个是本文的例子中所用的数据集的来源：
LSTM模型构建和训练
LSTM是一种适合于序列数据的深度学习模型，常用于时间序列预测。我们可以使用LSTM来预测航班延误。在构建LSTM模型之前，我们需要将数据集分为训练集和测试集。训练集用于训练模型，测试集用于评估模型的性能。在训练LSTM模型时，我们需要确定一些参数，如LSTM层数、神经元个数、迭代次数等。我们还需要选择合适的损失函数和优化器。在训练完模型后，我们可以使用测试集来评估模型的性能。
1.导入包


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19


import pandas as pd
from tensorflow.keras import layers,models,optimizers
from keras.models import Sequential
from tensorflow.keras.layers import Dropout
from keras.layers import LSTM,Dense,Flatten
from tensorflow.keras.losses import MeanSquaredError
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split
from keras.callbacks import EarlyStopping
import numpy as np
import matplotlib.pyplot as plt
import tensorflow as tf
from os.path import exists
!nvidia-smi
import os
for dirname, _, filenames in os.walk(&#39;/kaggle/input&#39;):
    for filename in filenames:
        print(os.path.join(dirname, filename))
os.environ[&#39;CUDA_VISIBLE_DEVICES&#39;] = &#34;0&#34;




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23


Thu Apr 13 16:28:46 2023
&#43;-----------------------------------------------------------------------------&#43;
| NVIDIA-SMI 470.161.03   Driver Version: 470.161.03   CUDA Version: 11.4     |
|-------------------------------&#43;----------------------&#43;----------------------&#43;
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================&#43;======================&#43;======================|
|   0  Tesla P100-PCIE...  Off  | 00000000:00:04.0 Off |                    0 |
| N/A   38C    P0    27W / 250W |      0MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
&#43;-------------------------------&#43;----------------------&#43;----------------------&#43;

&#43;-----------------------------------------------------------------------------&#43;
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|  No running processes found                                                 |
&#43;-----------------------------------------------------------------------------&#43;
/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv
/kaggle/input/airlinedelay/Airline%20Delay.csv
/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv


2.导入数据集


1
2
3
4
5


#导入数据集，分为大中小
# df=pd.read_csv(&#39;/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv&#39;)#mid
# df=pd.read_csv(&#39;/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv&#39;)#big
df=pd.read_csv(&#39;/kaggle/input/airlinedelay/Airline%20Delay.csv&#39;)#small
df.dropna(inplace=True,axis=0)


3.进行简单的数据预处理，这里我使用了中位数进行对每个特征求出对应的值


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26


# 首先通过 df[&#39;arr_cancelled&#39;]==0 这个条件筛选掉了所有 arr_cancelled 列中值为 1 的行，也就是已经取消的航班。
df=df[df[&#39;arr_cancelled&#39;]==0]

# 然后将 carrier_ct、weather_ct、nas_ct、security_ct 和 late_aircraft_ct 这五列重新赋值，除以 arr_flights 列对应行的值，计算每种延误类型对总到达航班数的占比
arrivingFlights=df[&#39;arr_flights&#39;]
df[&#39;carrier_ct&#39;]=df[&#39;carrier_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;weather_ct&#39;]=df[&#39;weather_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;nas_ct&#39;]=df[&#39;nas_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;security_ct&#39;]=df[&#39;security_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;late_aircraft_ct&#39;]=df[&#39;late_aircraft_ct&#39;]/df[&#39;arr_flights&#39;]
# 接着，将 carrier_delay、weather_delay、security_delay 和 late_aircraft_delay 分别除以 arr_flights 对应行的值，计算每种延误类型对总延误时间的占比。
df[&#39;carrier_delay&#39;]=df[&#39;carrier_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;weather_delay&#39;]=df[&#39;weather_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;security_delay&#39;]=df[&#39;security_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;late_aircraft_delay&#39;]=df[&#39;late_aircraft_delay&#39;]/df[&#39;arr_flights&#39;]
# 将 arr_delay 列除以 arr_flights 对应行的值，计算平均每个到达航班的延误时间。
df[&#39;arr_delay&#39;]=df[&#39;arr_delay&#39;]/df[&#39;arr_flights&#39;]

# 计算 arr_delay 列的标准差和均值，然后求出阈值（threshhold），这里将阈值设为平均值加两倍标准差。
std=df[&#39;arr_delay&#39;].std()
mean=df[&#39;arr_delay&#39;].mean()
threshhold=mean&#43;2*std
filter=((df[&#39;arr_delay&#39;]&lt;threshhold))

# 最后根据阈值和 arr_delay 列的值进行筛选，将 arr_delay 列的值小于阈值的行保留，其余行删除，即剔除过度偏离平均水平的异常值，返回一个新的数据帧 df。
df=df[filter]




1
2
3
4
5
6
7
8
9


# 画图，延误的分钟，横坐标为时间序
df[&#39;carrier_delay&#39;].plot(legend=&#39;Carrier&#39;)
df[&#39;weather_delay&#39;].plot(legend=&#39;Weather&#39;)
df[&#39;security_delay&#39;].plot(legend=&#39;Security&#39;)
df[&#39;late_aircraft_delay&#39;].plot(legend=&#39;Late&#39;)
plt.title(&#39;delay in minutes&#39;)
plt.legend()
plt.show()
# 从这里我们可以看到，大多数的延误时间在10-15分钟，所以使用这个来判断航班是否延误





1
2
3
4
5
6


# 差不多也是中位数
df[&#39;carrier_ct&#39;].plot()
df[&#39;nas_ct&#39;].plot()
df[&#39;security_ct&#39;].plot()
df[&#39;late_aircraft_ct&#39;].plot()
plt.show()





1
2
3
4
5
6
7


# 航空公司计数
fig, ax = plt.subplots(figsize=(15,4))
carrier=df[df.groupby(&#34;carrier_name&#34;)[&#39;carrier_name&#39;].transform(&#39;size&#39;) &gt; 9][&#34;carrier_name&#34;]

carrier.value_counts().plot(kind=&#34;bar&#34;,ax=ax)
plt.title(&#34;Carrier Flight counts&#34;)
plt.show()





1
2
3
4
5
6
7


# 机场计数
fig, ax = plt.subplots(figsize=(15,4))
flights=df[df.groupby(&#34;airport&#34;)[&#39;airport&#39;].transform(&#39;size&#39;) &gt; 9][&#34;airport&#34;]

flights.value_counts().plot(kind=&#34;bar&#34;,ax=ax)
plt.title(&#34;Airport Flight counts&#34;)
plt.show()





 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47


encoder=LabelEncoder()
# 删掉没有用的列
df[&#39;carrier&#39;]=encoder.fit_transform(df[&#39;carrier&#39;])
df[&#39;airport&#39;]=encoder.fit_transform(df[&#39;airport&#39;])
if &#34;airport_name&#34; in df.columns:
    df.drop([&#34;arr_del15&#34;,&#34;arr_cancelled&#34;,&#34;year&#34;, &#34;airport_name&#34;,&#34;carrier_name&#34;,&#34;nas_delay&#34;,],axis=1,inplace=True)

# 对数据进行二分处理，若某条数据中的延误时间大于 10 分钟，这一列对应的值被标记为 1，否则标记为 0。这样处理之后，这三列数据变成了二分类变量。
def arr_delay_columns(row):
    if row[&#39;arr_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
df[&#39;label&#39;] = df.apply(arr_delay_columns, axis=1)

def late_aircraft_delay_columns(row):
    if row[&#39;late_aircraft_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
def carrier_delay_columns(row):
    if row[&#39;carrier_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
# 画图 可以看到延误的航班大约占30%
print(&#34;delay mean:&#34;,df[&#39;arr_delay&#39;].mean(),df[&#39;arr_delay&#39;].max())
print(&#34;late_aircraft_delay mean:&#34;,df[&#39;late_aircraft_delay&#39;].mean(),df[&#39;late_aircraft_delay&#39;].max())
print(&#34;carrier_delay mean:&#34;,df[&#39;carrier_delay&#39;].mean(),df[&#39;carrier_delay&#39;].max())

df[&#39;late_aircraft_delay&#39;] = df.apply(late_aircraft_delay_columns, axis=1)
df[&#39;carrier_delay&#39;] = df.apply(carrier_delay_columns, axis=1)

counts = df[&#34;label&#34;].value_counts()
total = df[&#34;label&#34;].count()

percents = counts / total

plt.pie(percents, labels=percents.index, autopct=&#39;%1.1f%%&#39;)
plt.title(&#39;{} distribution&#39;.format(&#34;label&#34;))
plt.show()
delay mean: 8.184618800493773 28.467741935483872
late_aircraft_delay mean: 2.7714400135202206 24.285714285714285
carrier_delay mean: 3.2955479971538186 26.5





 1
 2
 3
 4
 5
 6
 7
 8
 9
10


# 分割数据集，训练集和验证集
X_columns=[x for x in df.columns if not x in[&#39;label&#39;,&#39;arr_delay&#39;]]

X=df[X_columns]
y=df[&#39;label&#39;]

print(X_columns)

X_train, X_test, y_train, y_test = train_test_split( X, y, test_size=0.22, random_state=42)
[&#39;month&#39;, &#39;carrier&#39;, &#39;airport&#39;, &#39;arr_flights&#39;, &#39;carrier_ct&#39;, &#39;weather_ct&#39;, &#39;nas_ct&#39;, &#39;security_ct&#39;, &#39;late_aircraft_ct&#39;, &#39;arr_diverted&#39;, &#39;carrier_delay&#39;, &#39;weather_delay&#39;, &#39;security_delay&#39;, &#39;late_aircraft_delay&#39;]




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32


#建立LSTM模型
lookback=6
n_features=len(X_columns)

# inputs = layers.Input((lookback, n_features), dtype=&#34;float32&#34;)
# x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=True)(inputs)
# x = layers.BatchNormalization()(x)
# x = layers.Dropout(0.25)(x)
# x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=False)(x)
# x = layers.BatchNormalization()(x)
# x = layers.Dropout(0.25)(x)
# x = layers.Dense(100, activation=&#39;relu&#39;)(x)
# outputs = layers.Dense(1, activation=&#39;sigmoid&#39;)(x)

inputs = layers.Input((lookback, n_features),dtype=&#34;float32&#34;)
lstm1 = layers.LSTM(128, activation=&#39;tanh&#39;, return_sequences=True)
lstm2 = layers.LSTM(64, activation=&#39;tanh&#39;, return_sequences=False)
batch1 = layers.BatchNormalization()
dropout1 = layers.Dropout(0.2)
dense1 = layers.Dense(100)
dense2 = layers.Dense(50)
output = layers.Dense(1,activation=&#34;sigmoid&#34;)

out = lstm1(inputs)
out = lstm2(out)
out = batch1(out)
out = dense1(out)
out = dropout1(out)
out = dense2(out)
outputs = output(out)

#model = models.Model(inputs=inputs, outputs=outputs)




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40


model = models.Model(inputs, outputs)

optimizer = optimizers.Adam()
model.compile(
    optimizer=optimizer,
    loss=&#39;binary_crossentropy&#39;,
    #loss=MeanSquaredError(reduction=&#34;auto&#34;, name=&#34;mean_squared_error&#34;),
    weighted_metrics=[&#34;acc&#34;],
)

model.summary()

es = EarlyStopping(monitor=&#34;val_loss&#34;, mode=&#34;min&#34;, verbose=1, patience=20)

# 转换数据格式，输入数据 X 和标签 y 分别转换为 np.array 格式，并使用 .astype(np.float32) 将数据类型转为浮点数类型。
X2_train = np.asarray(X_train).astype(np.float32)
X2_train = np.resize(X2_train,(X2_train.shape[0],lookback,X2_train.shape[1]))
y2_train = np.asarray(y_train).astype(np.float32)

X2_test = np.asarray(X_test).astype(np.float32)
X2_test = np.resize(X2_test,(X2_test.shape[0],lookback,X2_test.shape[1]))
y2_test = np.asarray(y_test).astype(np.float32)

path_to_file=&#34;/kaggle/working/lstm3.h5&#34;
file_exists = exists(path_to_file)
if(file_exists):
    model.load_weights(path_to_file)

# Fit data
history = model.fit(
    X2_train,
    y2_train,
    epochs=200,
    validation_data=(X2_test, y2_test),
    # verbose=0,
    shuffle=False,
    #callbacks=[es],
)

model.save_weights(path_to_file)




1
2
3
4
5
6
7
8


# 训练loss
plt.plot(history.history[&#34;loss&#34;],label=&#34;Train Loss&#34;)
plt.plot(history.history[&#34;val_loss&#34;],label=&#34;Validation Loss&#34;)
plt.title(&#34;Loss vs Epochs&#34;)
plt.xlabel(&#34;Epochs&#34;)
plt.ylabel(&#34;Loss&#34;)
plt.legend()
plt.show()





1
2


y_pred=model.predict(X2_train)
y_pred=[float(x) if x&gt;0.5 else 0 for x in y_pred]


43/43 [==============================] - 1s 3ms/step


1
2
3
4
5
6


fig, ax = plt.subplots(figsize=(15,8))
legend_labels=[&#34;Prediction&#34;,&#34;Train&#34;]
colors=[&#34;Blue&#34;,&#34;Red&#34;]
units=np.arange(0,100)
ax.stackplot(units,y_pred[0:100],[1 if y&gt;0.5 else 0 for y in y_train][0:100],labels=legend_labels,colors=colors)
print(np.max(y_train))





1
2
3
4
5
6
7
8


def accuracy(predictions, labels):
    correct=0
    for index,x in enumerate(predictions):
        if predictions[index] == labels[index]:
            correct&#43;=1
    return (100.0 * correct
           / len(predictions))
print(&#34;accuracy: &#34;,accuracy(y_pred[0:100],[1 if y&gt;0.5 else 0 for y in y_train][0:100]))


accuracy: 90.0
模型预测和评估
在模型训练完成后，我们可以使用该模型来预测航班延误。我们可以将实时数据输入到模型中，模型将输出延误的概率。我们还可以使用各种指标来评估模型的性能，如平均绝对误差、均方误差等。如果模型的性能不够好，我们可以尝试调整模型参数、增加训练数据等方法来提高模型性能。
总结
本文介绍了如何使用LSTM来预测航班延误。我们需要收集和预处理数据，构建和训练LSTM模型，使用模型预测和评估模型性能。预测航班延误对于航空公司和旅客都非常重要，希望这篇文章能够帮助你了解如何使用LSTM来预测航班延误。" /><meta name="keywords" content='LSTM,, 机器学习,, 机器学习算法,, 机器学习模型' /><meta itemprop="name" content="使用LSTM对航班延误进行预测">
<meta itemprop="description" content="使用LSTM预测航班延误
介绍
航班延误是航空公司和乘客都不愿意面对的问题。在某些情况下，延误可能会导致航空公司的巨额损失，也会影响旅客的日常生活。因此，预测航班延误对于航空公司和旅客来说都非常重要。在本文中，我们将介绍如何使用LSTM来预测航班延误。
数据收集和预处理
要预测航班延误，我们需要收集航班数据。我们可以从航空公司、机场网站或第三方数据提供商那里获取数据。在本文中，我们使用开放数据集“航班延误和取消数据”来预测航班延误。在收集数据后，我们需要对数据进行预处理。这包括清洗数据、处理缺失值和异常值等。我们还需要将数据转换为适合LSTM模型的形式。
这个是本文的例子中所用的数据集的来源：
LSTM模型构建和训练
LSTM是一种适合于序列数据的深度学习模型，常用于时间序列预测。我们可以使用LSTM来预测航班延误。在构建LSTM模型之前，我们需要将数据集分为训练集和测试集。训练集用于训练模型，测试集用于评估模型的性能。在训练LSTM模型时，我们需要确定一些参数，如LSTM层数、神经元个数、迭代次数等。我们还需要选择合适的损失函数和优化器。在训练完模型后，我们可以使用测试集来评估模型的性能。
1.导入包


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19


import pandas as pd
from tensorflow.keras import layers,models,optimizers
from keras.models import Sequential
from tensorflow.keras.layers import Dropout
from keras.layers import LSTM,Dense,Flatten
from tensorflow.keras.losses import MeanSquaredError
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split
from keras.callbacks import EarlyStopping
import numpy as np
import matplotlib.pyplot as plt
import tensorflow as tf
from os.path import exists
!nvidia-smi
import os
for dirname, _, filenames in os.walk(&#39;/kaggle/input&#39;):
    for filename in filenames:
        print(os.path.join(dirname, filename))
os.environ[&#39;CUDA_VISIBLE_DEVICES&#39;] = &#34;0&#34;




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23


Thu Apr 13 16:28:46 2023
&#43;-----------------------------------------------------------------------------&#43;
| NVIDIA-SMI 470.161.03   Driver Version: 470.161.03   CUDA Version: 11.4     |
|-------------------------------&#43;----------------------&#43;----------------------&#43;
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================&#43;======================&#43;======================|
|   0  Tesla P100-PCIE...  Off  | 00000000:00:04.0 Off |                    0 |
| N/A   38C    P0    27W / 250W |      0MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
&#43;-------------------------------&#43;----------------------&#43;----------------------&#43;

&#43;-----------------------------------------------------------------------------&#43;
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|  No running processes found                                                 |
&#43;-----------------------------------------------------------------------------&#43;
/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv
/kaggle/input/airlinedelay/Airline%20Delay.csv
/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv


2.导入数据集


1
2
3
4
5


#导入数据集，分为大中小
# df=pd.read_csv(&#39;/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv&#39;)#mid
# df=pd.read_csv(&#39;/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv&#39;)#big
df=pd.read_csv(&#39;/kaggle/input/airlinedelay/Airline%20Delay.csv&#39;)#small
df.dropna(inplace=True,axis=0)


3.进行简单的数据预处理，这里我使用了中位数进行对每个特征求出对应的值


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26


# 首先通过 df[&#39;arr_cancelled&#39;]==0 这个条件筛选掉了所有 arr_cancelled 列中值为 1 的行，也就是已经取消的航班。
df=df[df[&#39;arr_cancelled&#39;]==0]

# 然后将 carrier_ct、weather_ct、nas_ct、security_ct 和 late_aircraft_ct 这五列重新赋值，除以 arr_flights 列对应行的值，计算每种延误类型对总到达航班数的占比
arrivingFlights=df[&#39;arr_flights&#39;]
df[&#39;carrier_ct&#39;]=df[&#39;carrier_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;weather_ct&#39;]=df[&#39;weather_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;nas_ct&#39;]=df[&#39;nas_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;security_ct&#39;]=df[&#39;security_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;late_aircraft_ct&#39;]=df[&#39;late_aircraft_ct&#39;]/df[&#39;arr_flights&#39;]
# 接着，将 carrier_delay、weather_delay、security_delay 和 late_aircraft_delay 分别除以 arr_flights 对应行的值，计算每种延误类型对总延误时间的占比。
df[&#39;carrier_delay&#39;]=df[&#39;carrier_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;weather_delay&#39;]=df[&#39;weather_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;security_delay&#39;]=df[&#39;security_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;late_aircraft_delay&#39;]=df[&#39;late_aircraft_delay&#39;]/df[&#39;arr_flights&#39;]
# 将 arr_delay 列除以 arr_flights 对应行的值，计算平均每个到达航班的延误时间。
df[&#39;arr_delay&#39;]=df[&#39;arr_delay&#39;]/df[&#39;arr_flights&#39;]

# 计算 arr_delay 列的标准差和均值，然后求出阈值（threshhold），这里将阈值设为平均值加两倍标准差。
std=df[&#39;arr_delay&#39;].std()
mean=df[&#39;arr_delay&#39;].mean()
threshhold=mean&#43;2*std
filter=((df[&#39;arr_delay&#39;]&lt;threshhold))

# 最后根据阈值和 arr_delay 列的值进行筛选，将 arr_delay 列的值小于阈值的行保留，其余行删除，即剔除过度偏离平均水平的异常值，返回一个新的数据帧 df。
df=df[filter]




1
2
3
4
5
6
7
8
9


# 画图，延误的分钟，横坐标为时间序
df[&#39;carrier_delay&#39;].plot(legend=&#39;Carrier&#39;)
df[&#39;weather_delay&#39;].plot(legend=&#39;Weather&#39;)
df[&#39;security_delay&#39;].plot(legend=&#39;Security&#39;)
df[&#39;late_aircraft_delay&#39;].plot(legend=&#39;Late&#39;)
plt.title(&#39;delay in minutes&#39;)
plt.legend()
plt.show()
# 从这里我们可以看到，大多数的延误时间在10-15分钟，所以使用这个来判断航班是否延误





1
2
3
4
5
6


# 差不多也是中位数
df[&#39;carrier_ct&#39;].plot()
df[&#39;nas_ct&#39;].plot()
df[&#39;security_ct&#39;].plot()
df[&#39;late_aircraft_ct&#39;].plot()
plt.show()





1
2
3
4
5
6
7


# 航空公司计数
fig, ax = plt.subplots(figsize=(15,4))
carrier=df[df.groupby(&#34;carrier_name&#34;)[&#39;carrier_name&#39;].transform(&#39;size&#39;) &gt; 9][&#34;carrier_name&#34;]

carrier.value_counts().plot(kind=&#34;bar&#34;,ax=ax)
plt.title(&#34;Carrier Flight counts&#34;)
plt.show()





1
2
3
4
5
6
7


# 机场计数
fig, ax = plt.subplots(figsize=(15,4))
flights=df[df.groupby(&#34;airport&#34;)[&#39;airport&#39;].transform(&#39;size&#39;) &gt; 9][&#34;airport&#34;]

flights.value_counts().plot(kind=&#34;bar&#34;,ax=ax)
plt.title(&#34;Airport Flight counts&#34;)
plt.show()





 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47


encoder=LabelEncoder()
# 删掉没有用的列
df[&#39;carrier&#39;]=encoder.fit_transform(df[&#39;carrier&#39;])
df[&#39;airport&#39;]=encoder.fit_transform(df[&#39;airport&#39;])
if &#34;airport_name&#34; in df.columns:
    df.drop([&#34;arr_del15&#34;,&#34;arr_cancelled&#34;,&#34;year&#34;, &#34;airport_name&#34;,&#34;carrier_name&#34;,&#34;nas_delay&#34;,],axis=1,inplace=True)

# 对数据进行二分处理，若某条数据中的延误时间大于 10 分钟，这一列对应的值被标记为 1，否则标记为 0。这样处理之后，这三列数据变成了二分类变量。
def arr_delay_columns(row):
    if row[&#39;arr_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
df[&#39;label&#39;] = df.apply(arr_delay_columns, axis=1)

def late_aircraft_delay_columns(row):
    if row[&#39;late_aircraft_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
def carrier_delay_columns(row):
    if row[&#39;carrier_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
# 画图 可以看到延误的航班大约占30%
print(&#34;delay mean:&#34;,df[&#39;arr_delay&#39;].mean(),df[&#39;arr_delay&#39;].max())
print(&#34;late_aircraft_delay mean:&#34;,df[&#39;late_aircraft_delay&#39;].mean(),df[&#39;late_aircraft_delay&#39;].max())
print(&#34;carrier_delay mean:&#34;,df[&#39;carrier_delay&#39;].mean(),df[&#39;carrier_delay&#39;].max())

df[&#39;late_aircraft_delay&#39;] = df.apply(late_aircraft_delay_columns, axis=1)
df[&#39;carrier_delay&#39;] = df.apply(carrier_delay_columns, axis=1)

counts = df[&#34;label&#34;].value_counts()
total = df[&#34;label&#34;].count()

percents = counts / total

plt.pie(percents, labels=percents.index, autopct=&#39;%1.1f%%&#39;)
plt.title(&#39;{} distribution&#39;.format(&#34;label&#34;))
plt.show()
delay mean: 8.184618800493773 28.467741935483872
late_aircraft_delay mean: 2.7714400135202206 24.285714285714285
carrier_delay mean: 3.2955479971538186 26.5





 1
 2
 3
 4
 5
 6
 7
 8
 9
10


# 分割数据集，训练集和验证集
X_columns=[x for x in df.columns if not x in[&#39;label&#39;,&#39;arr_delay&#39;]]

X=df[X_columns]
y=df[&#39;label&#39;]

print(X_columns)

X_train, X_test, y_train, y_test = train_test_split( X, y, test_size=0.22, random_state=42)
[&#39;month&#39;, &#39;carrier&#39;, &#39;airport&#39;, &#39;arr_flights&#39;, &#39;carrier_ct&#39;, &#39;weather_ct&#39;, &#39;nas_ct&#39;, &#39;security_ct&#39;, &#39;late_aircraft_ct&#39;, &#39;arr_diverted&#39;, &#39;carrier_delay&#39;, &#39;weather_delay&#39;, &#39;security_delay&#39;, &#39;late_aircraft_delay&#39;]




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32


#建立LSTM模型
lookback=6
n_features=len(X_columns)

# inputs = layers.Input((lookback, n_features), dtype=&#34;float32&#34;)
# x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=True)(inputs)
# x = layers.BatchNormalization()(x)
# x = layers.Dropout(0.25)(x)
# x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=False)(x)
# x = layers.BatchNormalization()(x)
# x = layers.Dropout(0.25)(x)
# x = layers.Dense(100, activation=&#39;relu&#39;)(x)
# outputs = layers.Dense(1, activation=&#39;sigmoid&#39;)(x)

inputs = layers.Input((lookback, n_features),dtype=&#34;float32&#34;)
lstm1 = layers.LSTM(128, activation=&#39;tanh&#39;, return_sequences=True)
lstm2 = layers.LSTM(64, activation=&#39;tanh&#39;, return_sequences=False)
batch1 = layers.BatchNormalization()
dropout1 = layers.Dropout(0.2)
dense1 = layers.Dense(100)
dense2 = layers.Dense(50)
output = layers.Dense(1,activation=&#34;sigmoid&#34;)

out = lstm1(inputs)
out = lstm2(out)
out = batch1(out)
out = dense1(out)
out = dropout1(out)
out = dense2(out)
outputs = output(out)

#model = models.Model(inputs=inputs, outputs=outputs)




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40


model = models.Model(inputs, outputs)

optimizer = optimizers.Adam()
model.compile(
    optimizer=optimizer,
    loss=&#39;binary_crossentropy&#39;,
    #loss=MeanSquaredError(reduction=&#34;auto&#34;, name=&#34;mean_squared_error&#34;),
    weighted_metrics=[&#34;acc&#34;],
)

model.summary()

es = EarlyStopping(monitor=&#34;val_loss&#34;, mode=&#34;min&#34;, verbose=1, patience=20)

# 转换数据格式，输入数据 X 和标签 y 分别转换为 np.array 格式，并使用 .astype(np.float32) 将数据类型转为浮点数类型。
X2_train = np.asarray(X_train).astype(np.float32)
X2_train = np.resize(X2_train,(X2_train.shape[0],lookback,X2_train.shape[1]))
y2_train = np.asarray(y_train).astype(np.float32)

X2_test = np.asarray(X_test).astype(np.float32)
X2_test = np.resize(X2_test,(X2_test.shape[0],lookback,X2_test.shape[1]))
y2_test = np.asarray(y_test).astype(np.float32)

path_to_file=&#34;/kaggle/working/lstm3.h5&#34;
file_exists = exists(path_to_file)
if(file_exists):
    model.load_weights(path_to_file)

# Fit data
history = model.fit(
    X2_train,
    y2_train,
    epochs=200,
    validation_data=(X2_test, y2_test),
    # verbose=0,
    shuffle=False,
    #callbacks=[es],
)

model.save_weights(path_to_file)




1
2
3
4
5
6
7
8


# 训练loss
plt.plot(history.history[&#34;loss&#34;],label=&#34;Train Loss&#34;)
plt.plot(history.history[&#34;val_loss&#34;],label=&#34;Validation Loss&#34;)
plt.title(&#34;Loss vs Epochs&#34;)
plt.xlabel(&#34;Epochs&#34;)
plt.ylabel(&#34;Loss&#34;)
plt.legend()
plt.show()





1
2


y_pred=model.predict(X2_train)
y_pred=[float(x) if x&gt;0.5 else 0 for x in y_pred]


43/43 [==============================] - 1s 3ms/step


1
2
3
4
5
6


fig, ax = plt.subplots(figsize=(15,8))
legend_labels=[&#34;Prediction&#34;,&#34;Train&#34;]
colors=[&#34;Blue&#34;,&#34;Red&#34;]
units=np.arange(0,100)
ax.stackplot(units,y_pred[0:100],[1 if y&gt;0.5 else 0 for y in y_train][0:100],labels=legend_labels,colors=colors)
print(np.max(y_train))





1
2
3
4
5
6
7
8


def accuracy(predictions, labels):
    correct=0
    for index,x in enumerate(predictions):
        if predictions[index] == labels[index]:
            correct&#43;=1
    return (100.0 * correct
           / len(predictions))
print(&#34;accuracy: &#34;,accuracy(y_pred[0:100],[1 if y&gt;0.5 else 0 for y in y_train][0:100]))


accuracy: 90.0
模型预测和评估
在模型训练完成后，我们可以使用该模型来预测航班延误。我们可以将实时数据输入到模型中，模型将输出延误的概率。我们还可以使用各种指标来评估模型的性能，如平均绝对误差、均方误差等。如果模型的性能不够好，我们可以尝试调整模型参数、增加训练数据等方法来提高模型性能。
总结
本文介绍了如何使用LSTM来预测航班延误。我们需要收集和预处理数据，构建和训练LSTM模型，使用模型预测和评估模型性能。预测航班延误对于航空公司和旅客都非常重要，希望这篇文章能够帮助你了解如何使用LSTM来预测航班延误。"><meta itemprop="datePublished" content="2023-04-16T23:15:32+08:00" />
<meta itemprop="dateModified" content="2023-04-16T23:15:32+08:00" />
<meta itemprop="wordCount" content="2249">
<meta itemprop="keywords" content="机器学习,LSTM," /><meta property="og:title" content="使用LSTM对航班延误进行预测" />
<meta property="og:description" content="使用LSTM预测航班延误
介绍
航班延误是航空公司和乘客都不愿意面对的问题。在某些情况下，延误可能会导致航空公司的巨额损失，也会影响旅客的日常生活。因此，预测航班延误对于航空公司和旅客来说都非常重要。在本文中，我们将介绍如何使用LSTM来预测航班延误。
数据收集和预处理
要预测航班延误，我们需要收集航班数据。我们可以从航空公司、机场网站或第三方数据提供商那里获取数据。在本文中，我们使用开放数据集“航班延误和取消数据”来预测航班延误。在收集数据后，我们需要对数据进行预处理。这包括清洗数据、处理缺失值和异常值等。我们还需要将数据转换为适合LSTM模型的形式。
这个是本文的例子中所用的数据集的来源：
LSTM模型构建和训练
LSTM是一种适合于序列数据的深度学习模型，常用于时间序列预测。我们可以使用LSTM来预测航班延误。在构建LSTM模型之前，我们需要将数据集分为训练集和测试集。训练集用于训练模型，测试集用于评估模型的性能。在训练LSTM模型时，我们需要确定一些参数，如LSTM层数、神经元个数、迭代次数等。我们还需要选择合适的损失函数和优化器。在训练完模型后，我们可以使用测试集来评估模型的性能。
1.导入包


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19


import pandas as pd
from tensorflow.keras import layers,models,optimizers
from keras.models import Sequential
from tensorflow.keras.layers import Dropout
from keras.layers import LSTM,Dense,Flatten
from tensorflow.keras.losses import MeanSquaredError
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split
from keras.callbacks import EarlyStopping
import numpy as np
import matplotlib.pyplot as plt
import tensorflow as tf
from os.path import exists
!nvidia-smi
import os
for dirname, _, filenames in os.walk(&#39;/kaggle/input&#39;):
    for filename in filenames:
        print(os.path.join(dirname, filename))
os.environ[&#39;CUDA_VISIBLE_DEVICES&#39;] = &#34;0&#34;




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23


Thu Apr 13 16:28:46 2023
&#43;-----------------------------------------------------------------------------&#43;
| NVIDIA-SMI 470.161.03   Driver Version: 470.161.03   CUDA Version: 11.4     |
|-------------------------------&#43;----------------------&#43;----------------------&#43;
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================&#43;======================&#43;======================|
|   0  Tesla P100-PCIE...  Off  | 00000000:00:04.0 Off |                    0 |
| N/A   38C    P0    27W / 250W |      0MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
&#43;-------------------------------&#43;----------------------&#43;----------------------&#43;

&#43;-----------------------------------------------------------------------------&#43;
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|  No running processes found                                                 |
&#43;-----------------------------------------------------------------------------&#43;
/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv
/kaggle/input/airlinedelay/Airline%20Delay.csv
/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv


2.导入数据集


1
2
3
4
5


#导入数据集，分为大中小
# df=pd.read_csv(&#39;/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv&#39;)#mid
# df=pd.read_csv(&#39;/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv&#39;)#big
df=pd.read_csv(&#39;/kaggle/input/airlinedelay/Airline%20Delay.csv&#39;)#small
df.dropna(inplace=True,axis=0)


3.进行简单的数据预处理，这里我使用了中位数进行对每个特征求出对应的值


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26


# 首先通过 df[&#39;arr_cancelled&#39;]==0 这个条件筛选掉了所有 arr_cancelled 列中值为 1 的行，也就是已经取消的航班。
df=df[df[&#39;arr_cancelled&#39;]==0]

# 然后将 carrier_ct、weather_ct、nas_ct、security_ct 和 late_aircraft_ct 这五列重新赋值，除以 arr_flights 列对应行的值，计算每种延误类型对总到达航班数的占比
arrivingFlights=df[&#39;arr_flights&#39;]
df[&#39;carrier_ct&#39;]=df[&#39;carrier_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;weather_ct&#39;]=df[&#39;weather_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;nas_ct&#39;]=df[&#39;nas_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;security_ct&#39;]=df[&#39;security_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;late_aircraft_ct&#39;]=df[&#39;late_aircraft_ct&#39;]/df[&#39;arr_flights&#39;]
# 接着，将 carrier_delay、weather_delay、security_delay 和 late_aircraft_delay 分别除以 arr_flights 对应行的值，计算每种延误类型对总延误时间的占比。
df[&#39;carrier_delay&#39;]=df[&#39;carrier_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;weather_delay&#39;]=df[&#39;weather_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;security_delay&#39;]=df[&#39;security_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;late_aircraft_delay&#39;]=df[&#39;late_aircraft_delay&#39;]/df[&#39;arr_flights&#39;]
# 将 arr_delay 列除以 arr_flights 对应行的值，计算平均每个到达航班的延误时间。
df[&#39;arr_delay&#39;]=df[&#39;arr_delay&#39;]/df[&#39;arr_flights&#39;]

# 计算 arr_delay 列的标准差和均值，然后求出阈值（threshhold），这里将阈值设为平均值加两倍标准差。
std=df[&#39;arr_delay&#39;].std()
mean=df[&#39;arr_delay&#39;].mean()
threshhold=mean&#43;2*std
filter=((df[&#39;arr_delay&#39;]&lt;threshhold))

# 最后根据阈值和 arr_delay 列的值进行筛选，将 arr_delay 列的值小于阈值的行保留，其余行删除，即剔除过度偏离平均水平的异常值，返回一个新的数据帧 df。
df=df[filter]




1
2
3
4
5
6
7
8
9


# 画图，延误的分钟，横坐标为时间序
df[&#39;carrier_delay&#39;].plot(legend=&#39;Carrier&#39;)
df[&#39;weather_delay&#39;].plot(legend=&#39;Weather&#39;)
df[&#39;security_delay&#39;].plot(legend=&#39;Security&#39;)
df[&#39;late_aircraft_delay&#39;].plot(legend=&#39;Late&#39;)
plt.title(&#39;delay in minutes&#39;)
plt.legend()
plt.show()
# 从这里我们可以看到，大多数的延误时间在10-15分钟，所以使用这个来判断航班是否延误





1
2
3
4
5
6


# 差不多也是中位数
df[&#39;carrier_ct&#39;].plot()
df[&#39;nas_ct&#39;].plot()
df[&#39;security_ct&#39;].plot()
df[&#39;late_aircraft_ct&#39;].plot()
plt.show()





1
2
3
4
5
6
7


# 航空公司计数
fig, ax = plt.subplots(figsize=(15,4))
carrier=df[df.groupby(&#34;carrier_name&#34;)[&#39;carrier_name&#39;].transform(&#39;size&#39;) &gt; 9][&#34;carrier_name&#34;]

carrier.value_counts().plot(kind=&#34;bar&#34;,ax=ax)
plt.title(&#34;Carrier Flight counts&#34;)
plt.show()





1
2
3
4
5
6
7


# 机场计数
fig, ax = plt.subplots(figsize=(15,4))
flights=df[df.groupby(&#34;airport&#34;)[&#39;airport&#39;].transform(&#39;size&#39;) &gt; 9][&#34;airport&#34;]

flights.value_counts().plot(kind=&#34;bar&#34;,ax=ax)
plt.title(&#34;Airport Flight counts&#34;)
plt.show()





 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47


encoder=LabelEncoder()
# 删掉没有用的列
df[&#39;carrier&#39;]=encoder.fit_transform(df[&#39;carrier&#39;])
df[&#39;airport&#39;]=encoder.fit_transform(df[&#39;airport&#39;])
if &#34;airport_name&#34; in df.columns:
    df.drop([&#34;arr_del15&#34;,&#34;arr_cancelled&#34;,&#34;year&#34;, &#34;airport_name&#34;,&#34;carrier_name&#34;,&#34;nas_delay&#34;,],axis=1,inplace=True)

# 对数据进行二分处理，若某条数据中的延误时间大于 10 分钟，这一列对应的值被标记为 1，否则标记为 0。这样处理之后，这三列数据变成了二分类变量。
def arr_delay_columns(row):
    if row[&#39;arr_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
df[&#39;label&#39;] = df.apply(arr_delay_columns, axis=1)

def late_aircraft_delay_columns(row):
    if row[&#39;late_aircraft_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
def carrier_delay_columns(row):
    if row[&#39;carrier_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
# 画图 可以看到延误的航班大约占30%
print(&#34;delay mean:&#34;,df[&#39;arr_delay&#39;].mean(),df[&#39;arr_delay&#39;].max())
print(&#34;late_aircraft_delay mean:&#34;,df[&#39;late_aircraft_delay&#39;].mean(),df[&#39;late_aircraft_delay&#39;].max())
print(&#34;carrier_delay mean:&#34;,df[&#39;carrier_delay&#39;].mean(),df[&#39;carrier_delay&#39;].max())

df[&#39;late_aircraft_delay&#39;] = df.apply(late_aircraft_delay_columns, axis=1)
df[&#39;carrier_delay&#39;] = df.apply(carrier_delay_columns, axis=1)

counts = df[&#34;label&#34;].value_counts()
total = df[&#34;label&#34;].count()

percents = counts / total

plt.pie(percents, labels=percents.index, autopct=&#39;%1.1f%%&#39;)
plt.title(&#39;{} distribution&#39;.format(&#34;label&#34;))
plt.show()
delay mean: 8.184618800493773 28.467741935483872
late_aircraft_delay mean: 2.7714400135202206 24.285714285714285
carrier_delay mean: 3.2955479971538186 26.5





 1
 2
 3
 4
 5
 6
 7
 8
 9
10


# 分割数据集，训练集和验证集
X_columns=[x for x in df.columns if not x in[&#39;label&#39;,&#39;arr_delay&#39;]]

X=df[X_columns]
y=df[&#39;label&#39;]

print(X_columns)

X_train, X_test, y_train, y_test = train_test_split( X, y, test_size=0.22, random_state=42)
[&#39;month&#39;, &#39;carrier&#39;, &#39;airport&#39;, &#39;arr_flights&#39;, &#39;carrier_ct&#39;, &#39;weather_ct&#39;, &#39;nas_ct&#39;, &#39;security_ct&#39;, &#39;late_aircraft_ct&#39;, &#39;arr_diverted&#39;, &#39;carrier_delay&#39;, &#39;weather_delay&#39;, &#39;security_delay&#39;, &#39;late_aircraft_delay&#39;]




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32


#建立LSTM模型
lookback=6
n_features=len(X_columns)

# inputs = layers.Input((lookback, n_features), dtype=&#34;float32&#34;)
# x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=True)(inputs)
# x = layers.BatchNormalization()(x)
# x = layers.Dropout(0.25)(x)
# x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=False)(x)
# x = layers.BatchNormalization()(x)
# x = layers.Dropout(0.25)(x)
# x = layers.Dense(100, activation=&#39;relu&#39;)(x)
# outputs = layers.Dense(1, activation=&#39;sigmoid&#39;)(x)

inputs = layers.Input((lookback, n_features),dtype=&#34;float32&#34;)
lstm1 = layers.LSTM(128, activation=&#39;tanh&#39;, return_sequences=True)
lstm2 = layers.LSTM(64, activation=&#39;tanh&#39;, return_sequences=False)
batch1 = layers.BatchNormalization()
dropout1 = layers.Dropout(0.2)
dense1 = layers.Dense(100)
dense2 = layers.Dense(50)
output = layers.Dense(1,activation=&#34;sigmoid&#34;)

out = lstm1(inputs)
out = lstm2(out)
out = batch1(out)
out = dense1(out)
out = dropout1(out)
out = dense2(out)
outputs = output(out)

#model = models.Model(inputs=inputs, outputs=outputs)




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40


model = models.Model(inputs, outputs)

optimizer = optimizers.Adam()
model.compile(
    optimizer=optimizer,
    loss=&#39;binary_crossentropy&#39;,
    #loss=MeanSquaredError(reduction=&#34;auto&#34;, name=&#34;mean_squared_error&#34;),
    weighted_metrics=[&#34;acc&#34;],
)

model.summary()

es = EarlyStopping(monitor=&#34;val_loss&#34;, mode=&#34;min&#34;, verbose=1, patience=20)

# 转换数据格式，输入数据 X 和标签 y 分别转换为 np.array 格式，并使用 .astype(np.float32) 将数据类型转为浮点数类型。
X2_train = np.asarray(X_train).astype(np.float32)
X2_train = np.resize(X2_train,(X2_train.shape[0],lookback,X2_train.shape[1]))
y2_train = np.asarray(y_train).astype(np.float32)

X2_test = np.asarray(X_test).astype(np.float32)
X2_test = np.resize(X2_test,(X2_test.shape[0],lookback,X2_test.shape[1]))
y2_test = np.asarray(y_test).astype(np.float32)

path_to_file=&#34;/kaggle/working/lstm3.h5&#34;
file_exists = exists(path_to_file)
if(file_exists):
    model.load_weights(path_to_file)

# Fit data
history = model.fit(
    X2_train,
    y2_train,
    epochs=200,
    validation_data=(X2_test, y2_test),
    # verbose=0,
    shuffle=False,
    #callbacks=[es],
)

model.save_weights(path_to_file)




1
2
3
4
5
6
7
8


# 训练loss
plt.plot(history.history[&#34;loss&#34;],label=&#34;Train Loss&#34;)
plt.plot(history.history[&#34;val_loss&#34;],label=&#34;Validation Loss&#34;)
plt.title(&#34;Loss vs Epochs&#34;)
plt.xlabel(&#34;Epochs&#34;)
plt.ylabel(&#34;Loss&#34;)
plt.legend()
plt.show()





1
2


y_pred=model.predict(X2_train)
y_pred=[float(x) if x&gt;0.5 else 0 for x in y_pred]


43/43 [==============================] - 1s 3ms/step


1
2
3
4
5
6


fig, ax = plt.subplots(figsize=(15,8))
legend_labels=[&#34;Prediction&#34;,&#34;Train&#34;]
colors=[&#34;Blue&#34;,&#34;Red&#34;]
units=np.arange(0,100)
ax.stackplot(units,y_pred[0:100],[1 if y&gt;0.5 else 0 for y in y_train][0:100],labels=legend_labels,colors=colors)
print(np.max(y_train))





1
2
3
4
5
6
7
8


def accuracy(predictions, labels):
    correct=0
    for index,x in enumerate(predictions):
        if predictions[index] == labels[index]:
            correct&#43;=1
    return (100.0 * correct
           / len(predictions))
print(&#34;accuracy: &#34;,accuracy(y_pred[0:100],[1 if y&gt;0.5 else 0 for y in y_train][0:100]))


accuracy: 90.0
模型预测和评估
在模型训练完成后，我们可以使用该模型来预测航班延误。我们可以将实时数据输入到模型中，模型将输出延误的概率。我们还可以使用各种指标来评估模型的性能，如平均绝对误差、均方误差等。如果模型的性能不够好，我们可以尝试调整模型参数、增加训练数据等方法来提高模型性能。
总结
本文介绍了如何使用LSTM来预测航班延误。我们需要收集和预处理数据，构建和训练LSTM模型，使用模型预测和评估模型性能。预测航班延误对于航空公司和旅客都非常重要，希望这篇文章能够帮助你了解如何使用LSTM来预测航班延误。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.579878700.xyz/lstm/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-16T23:15:32+08:00" />
<meta property="article:modified_time" content="2023-04-16T23:15:32+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用LSTM对航班延误进行预测"/>
<meta name="twitter:description" content="使用LSTM预测航班延误
介绍
航班延误是航空公司和乘客都不愿意面对的问题。在某些情况下，延误可能会导致航空公司的巨额损失，也会影响旅客的日常生活。因此，预测航班延误对于航空公司和旅客来说都非常重要。在本文中，我们将介绍如何使用LSTM来预测航班延误。
数据收集和预处理
要预测航班延误，我们需要收集航班数据。我们可以从航空公司、机场网站或第三方数据提供商那里获取数据。在本文中，我们使用开放数据集“航班延误和取消数据”来预测航班延误。在收集数据后，我们需要对数据进行预处理。这包括清洗数据、处理缺失值和异常值等。我们还需要将数据转换为适合LSTM模型的形式。
这个是本文的例子中所用的数据集的来源：
LSTM模型构建和训练
LSTM是一种适合于序列数据的深度学习模型，常用于时间序列预测。我们可以使用LSTM来预测航班延误。在构建LSTM模型之前，我们需要将数据集分为训练集和测试集。训练集用于训练模型，测试集用于评估模型的性能。在训练LSTM模型时，我们需要确定一些参数，如LSTM层数、神经元个数、迭代次数等。我们还需要选择合适的损失函数和优化器。在训练完模型后，我们可以使用测试集来评估模型的性能。
1.导入包


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19


import pandas as pd
from tensorflow.keras import layers,models,optimizers
from keras.models import Sequential
from tensorflow.keras.layers import Dropout
from keras.layers import LSTM,Dense,Flatten
from tensorflow.keras.losses import MeanSquaredError
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split
from keras.callbacks import EarlyStopping
import numpy as np
import matplotlib.pyplot as plt
import tensorflow as tf
from os.path import exists
!nvidia-smi
import os
for dirname, _, filenames in os.walk(&#39;/kaggle/input&#39;):
    for filename in filenames:
        print(os.path.join(dirname, filename))
os.environ[&#39;CUDA_VISIBLE_DEVICES&#39;] = &#34;0&#34;




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23


Thu Apr 13 16:28:46 2023
&#43;-----------------------------------------------------------------------------&#43;
| NVIDIA-SMI 470.161.03   Driver Version: 470.161.03   CUDA Version: 11.4     |
|-------------------------------&#43;----------------------&#43;----------------------&#43;
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================&#43;======================&#43;======================|
|   0  Tesla P100-PCIE...  Off  | 00000000:00:04.0 Off |                    0 |
| N/A   38C    P0    27W / 250W |      0MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
&#43;-------------------------------&#43;----------------------&#43;----------------------&#43;

&#43;-----------------------------------------------------------------------------&#43;
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|  No running processes found                                                 |
&#43;-----------------------------------------------------------------------------&#43;
/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv
/kaggle/input/airlinedelay/Airline%20Delay.csv
/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv


2.导入数据集


1
2
3
4
5


#导入数据集，分为大中小
# df=pd.read_csv(&#39;/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv&#39;)#mid
# df=pd.read_csv(&#39;/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv&#39;)#big
df=pd.read_csv(&#39;/kaggle/input/airlinedelay/Airline%20Delay.csv&#39;)#small
df.dropna(inplace=True,axis=0)


3.进行简单的数据预处理，这里我使用了中位数进行对每个特征求出对应的值


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26


# 首先通过 df[&#39;arr_cancelled&#39;]==0 这个条件筛选掉了所有 arr_cancelled 列中值为 1 的行，也就是已经取消的航班。
df=df[df[&#39;arr_cancelled&#39;]==0]

# 然后将 carrier_ct、weather_ct、nas_ct、security_ct 和 late_aircraft_ct 这五列重新赋值，除以 arr_flights 列对应行的值，计算每种延误类型对总到达航班数的占比
arrivingFlights=df[&#39;arr_flights&#39;]
df[&#39;carrier_ct&#39;]=df[&#39;carrier_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;weather_ct&#39;]=df[&#39;weather_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;nas_ct&#39;]=df[&#39;nas_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;security_ct&#39;]=df[&#39;security_ct&#39;]/df[&#39;arr_flights&#39;]
df[&#39;late_aircraft_ct&#39;]=df[&#39;late_aircraft_ct&#39;]/df[&#39;arr_flights&#39;]
# 接着，将 carrier_delay、weather_delay、security_delay 和 late_aircraft_delay 分别除以 arr_flights 对应行的值，计算每种延误类型对总延误时间的占比。
df[&#39;carrier_delay&#39;]=df[&#39;carrier_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;weather_delay&#39;]=df[&#39;weather_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;security_delay&#39;]=df[&#39;security_delay&#39;]/df[&#39;arr_flights&#39;]
df[&#39;late_aircraft_delay&#39;]=df[&#39;late_aircraft_delay&#39;]/df[&#39;arr_flights&#39;]
# 将 arr_delay 列除以 arr_flights 对应行的值，计算平均每个到达航班的延误时间。
df[&#39;arr_delay&#39;]=df[&#39;arr_delay&#39;]/df[&#39;arr_flights&#39;]

# 计算 arr_delay 列的标准差和均值，然后求出阈值（threshhold），这里将阈值设为平均值加两倍标准差。
std=df[&#39;arr_delay&#39;].std()
mean=df[&#39;arr_delay&#39;].mean()
threshhold=mean&#43;2*std
filter=((df[&#39;arr_delay&#39;]&lt;threshhold))

# 最后根据阈值和 arr_delay 列的值进行筛选，将 arr_delay 列的值小于阈值的行保留，其余行删除，即剔除过度偏离平均水平的异常值，返回一个新的数据帧 df。
df=df[filter]




1
2
3
4
5
6
7
8
9


# 画图，延误的分钟，横坐标为时间序
df[&#39;carrier_delay&#39;].plot(legend=&#39;Carrier&#39;)
df[&#39;weather_delay&#39;].plot(legend=&#39;Weather&#39;)
df[&#39;security_delay&#39;].plot(legend=&#39;Security&#39;)
df[&#39;late_aircraft_delay&#39;].plot(legend=&#39;Late&#39;)
plt.title(&#39;delay in minutes&#39;)
plt.legend()
plt.show()
# 从这里我们可以看到，大多数的延误时间在10-15分钟，所以使用这个来判断航班是否延误





1
2
3
4
5
6


# 差不多也是中位数
df[&#39;carrier_ct&#39;].plot()
df[&#39;nas_ct&#39;].plot()
df[&#39;security_ct&#39;].plot()
df[&#39;late_aircraft_ct&#39;].plot()
plt.show()





1
2
3
4
5
6
7


# 航空公司计数
fig, ax = plt.subplots(figsize=(15,4))
carrier=df[df.groupby(&#34;carrier_name&#34;)[&#39;carrier_name&#39;].transform(&#39;size&#39;) &gt; 9][&#34;carrier_name&#34;]

carrier.value_counts().plot(kind=&#34;bar&#34;,ax=ax)
plt.title(&#34;Carrier Flight counts&#34;)
plt.show()





1
2
3
4
5
6
7


# 机场计数
fig, ax = plt.subplots(figsize=(15,4))
flights=df[df.groupby(&#34;airport&#34;)[&#39;airport&#39;].transform(&#39;size&#39;) &gt; 9][&#34;airport&#34;]

flights.value_counts().plot(kind=&#34;bar&#34;,ax=ax)
plt.title(&#34;Airport Flight counts&#34;)
plt.show()





 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47


encoder=LabelEncoder()
# 删掉没有用的列
df[&#39;carrier&#39;]=encoder.fit_transform(df[&#39;carrier&#39;])
df[&#39;airport&#39;]=encoder.fit_transform(df[&#39;airport&#39;])
if &#34;airport_name&#34; in df.columns:
    df.drop([&#34;arr_del15&#34;,&#34;arr_cancelled&#34;,&#34;year&#34;, &#34;airport_name&#34;,&#34;carrier_name&#34;,&#34;nas_delay&#34;,],axis=1,inplace=True)

# 对数据进行二分处理，若某条数据中的延误时间大于 10 分钟，这一列对应的值被标记为 1，否则标记为 0。这样处理之后，这三列数据变成了二分类变量。
def arr_delay_columns(row):
    if row[&#39;arr_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
df[&#39;label&#39;] = df.apply(arr_delay_columns, axis=1)

def late_aircraft_delay_columns(row):
    if row[&#39;late_aircraft_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
def carrier_delay_columns(row):
    if row[&#39;carrier_delay&#39;] &gt; 10 :
        return 1
    else:
        return 0
    
# 画图 可以看到延误的航班大约占30%
print(&#34;delay mean:&#34;,df[&#39;arr_delay&#39;].mean(),df[&#39;arr_delay&#39;].max())
print(&#34;late_aircraft_delay mean:&#34;,df[&#39;late_aircraft_delay&#39;].mean(),df[&#39;late_aircraft_delay&#39;].max())
print(&#34;carrier_delay mean:&#34;,df[&#39;carrier_delay&#39;].mean(),df[&#39;carrier_delay&#39;].max())

df[&#39;late_aircraft_delay&#39;] = df.apply(late_aircraft_delay_columns, axis=1)
df[&#39;carrier_delay&#39;] = df.apply(carrier_delay_columns, axis=1)

counts = df[&#34;label&#34;].value_counts()
total = df[&#34;label&#34;].count()

percents = counts / total

plt.pie(percents, labels=percents.index, autopct=&#39;%1.1f%%&#39;)
plt.title(&#39;{} distribution&#39;.format(&#34;label&#34;))
plt.show()
delay mean: 8.184618800493773 28.467741935483872
late_aircraft_delay mean: 2.7714400135202206 24.285714285714285
carrier_delay mean: 3.2955479971538186 26.5





 1
 2
 3
 4
 5
 6
 7
 8
 9
10


# 分割数据集，训练集和验证集
X_columns=[x for x in df.columns if not x in[&#39;label&#39;,&#39;arr_delay&#39;]]

X=df[X_columns]
y=df[&#39;label&#39;]

print(X_columns)

X_train, X_test, y_train, y_test = train_test_split( X, y, test_size=0.22, random_state=42)
[&#39;month&#39;, &#39;carrier&#39;, &#39;airport&#39;, &#39;arr_flights&#39;, &#39;carrier_ct&#39;, &#39;weather_ct&#39;, &#39;nas_ct&#39;, &#39;security_ct&#39;, &#39;late_aircraft_ct&#39;, &#39;arr_diverted&#39;, &#39;carrier_delay&#39;, &#39;weather_delay&#39;, &#39;security_delay&#39;, &#39;late_aircraft_delay&#39;]




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32


#建立LSTM模型
lookback=6
n_features=len(X_columns)

# inputs = layers.Input((lookback, n_features), dtype=&#34;float32&#34;)
# x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=True)(inputs)
# x = layers.BatchNormalization()(x)
# x = layers.Dropout(0.25)(x)
# x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=False)(x)
# x = layers.BatchNormalization()(x)
# x = layers.Dropout(0.25)(x)
# x = layers.Dense(100, activation=&#39;relu&#39;)(x)
# outputs = layers.Dense(1, activation=&#39;sigmoid&#39;)(x)

inputs = layers.Input((lookback, n_features),dtype=&#34;float32&#34;)
lstm1 = layers.LSTM(128, activation=&#39;tanh&#39;, return_sequences=True)
lstm2 = layers.LSTM(64, activation=&#39;tanh&#39;, return_sequences=False)
batch1 = layers.BatchNormalization()
dropout1 = layers.Dropout(0.2)
dense1 = layers.Dense(100)
dense2 = layers.Dense(50)
output = layers.Dense(1,activation=&#34;sigmoid&#34;)

out = lstm1(inputs)
out = lstm2(out)
out = batch1(out)
out = dense1(out)
out = dropout1(out)
out = dense2(out)
outputs = output(out)

#model = models.Model(inputs=inputs, outputs=outputs)




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40


model = models.Model(inputs, outputs)

optimizer = optimizers.Adam()
model.compile(
    optimizer=optimizer,
    loss=&#39;binary_crossentropy&#39;,
    #loss=MeanSquaredError(reduction=&#34;auto&#34;, name=&#34;mean_squared_error&#34;),
    weighted_metrics=[&#34;acc&#34;],
)

model.summary()

es = EarlyStopping(monitor=&#34;val_loss&#34;, mode=&#34;min&#34;, verbose=1, patience=20)

# 转换数据格式，输入数据 X 和标签 y 分别转换为 np.array 格式，并使用 .astype(np.float32) 将数据类型转为浮点数类型。
X2_train = np.asarray(X_train).astype(np.float32)
X2_train = np.resize(X2_train,(X2_train.shape[0],lookback,X2_train.shape[1]))
y2_train = np.asarray(y_train).astype(np.float32)

X2_test = np.asarray(X_test).astype(np.float32)
X2_test = np.resize(X2_test,(X2_test.shape[0],lookback,X2_test.shape[1]))
y2_test = np.asarray(y_test).astype(np.float32)

path_to_file=&#34;/kaggle/working/lstm3.h5&#34;
file_exists = exists(path_to_file)
if(file_exists):
    model.load_weights(path_to_file)

# Fit data
history = model.fit(
    X2_train,
    y2_train,
    epochs=200,
    validation_data=(X2_test, y2_test),
    # verbose=0,
    shuffle=False,
    #callbacks=[es],
)

model.save_weights(path_to_file)




1
2
3
4
5
6
7
8


# 训练loss
plt.plot(history.history[&#34;loss&#34;],label=&#34;Train Loss&#34;)
plt.plot(history.history[&#34;val_loss&#34;],label=&#34;Validation Loss&#34;)
plt.title(&#34;Loss vs Epochs&#34;)
plt.xlabel(&#34;Epochs&#34;)
plt.ylabel(&#34;Loss&#34;)
plt.legend()
plt.show()





1
2


y_pred=model.predict(X2_train)
y_pred=[float(x) if x&gt;0.5 else 0 for x in y_pred]


43/43 [==============================] - 1s 3ms/step


1
2
3
4
5
6


fig, ax = plt.subplots(figsize=(15,8))
legend_labels=[&#34;Prediction&#34;,&#34;Train&#34;]
colors=[&#34;Blue&#34;,&#34;Red&#34;]
units=np.arange(0,100)
ax.stackplot(units,y_pred[0:100],[1 if y&gt;0.5 else 0 for y in y_train][0:100],labels=legend_labels,colors=colors)
print(np.max(y_train))





1
2
3
4
5
6
7
8


def accuracy(predictions, labels):
    correct=0
    for index,x in enumerate(predictions):
        if predictions[index] == labels[index]:
            correct&#43;=1
    return (100.0 * correct
           / len(predictions))
print(&#34;accuracy: &#34;,accuracy(y_pred[0:100],[1 if y&gt;0.5 else 0 for y in y_train][0:100]))


accuracy: 90.0
模型预测和评估
在模型训练完成后，我们可以使用该模型来预测航班延误。我们可以将实时数据输入到模型中，模型将输出延误的概率。我们还可以使用各种指标来评估模型的性能，如平均绝对误差、均方误差等。如果模型的性能不够好，我们可以尝试调整模型参数、增加训练数据等方法来提高模型性能。
总结
本文介绍了如何使用LSTM来预测航班延误。我们需要收集和预处理数据，构建和训练LSTM模型，使用模型预测和评估模型性能。预测航班延误对于航空公司和旅客都非常重要，希望这篇文章能够帮助你了解如何使用LSTM来预测航班延误。"/>
<meta name="application-name" content="waka&#39;s blog">
<meta name="apple-mobile-web-app-title" content="waka&#39;s blog"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="%e7%8b%90%e7%8b%b8.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://blog.579878700.xyz/lstm/" /><link rel="prev" href="http://blog.579878700.xyz/zkml/" /><link rel="next" href="http://blog.579878700.xyz/lstm_2/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "使用LSTM对航班延误进行预测",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/blog.579878700.xyz\/lstm\/"
    },"genre": "posts","keywords": "机器学习, LSTM","wordcount":  2249 ,
    "url": "http:\/\/blog.579878700.xyz\/lstm\/","datePublished": "2023-04-16T23:15:32+08:00","dateModified": "2023-04-16T23:15:32+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "waka"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="waka&#39;s blog"><img loading="lazy" src="/%e7%8b%90%e7%8b%b8.svg" srcset="/%e7%8b%90%e7%8b%b8.svg, /%e7%8b%90%e7%8b%b8.svg 1.5x, /%e7%8b%90%e7%8b%b8.svg 2x" sizes="auto" data-title="waka&#39;s blog" data-alt="waka&#39;s blog" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">waka&#39;s blog</span></a><span id="typeit-header-subtitle-desktop" class="typeit header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="waka&#39;s blog"><img loading="lazy" src="/%e7%8b%90%e7%8b%b8.svg" srcset="/%e7%8b%90%e7%8b%b8.svg, /%e7%8b%90%e7%8b%b8.svg 1.5x, /%e7%8b%90%e7%8b%b8.svg 2x" sizes="auto" data-title="/狐狸.svg" data-alt="/狐狸.svg" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">waka&#39;s blog</span></a><span id="typeit-header-subtitle-mobile" class="typeit header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>使用LSTM对航班延误进行预测</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/images/avatar.jpg" srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes="auto" data-title="waka" data-alt="waka" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/>&nbsp;waka</span></span>
          <span class="post-category">收录于 <a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 机器学习</a></span></div>
      <div class="post-meta-line"><span title=2023-04-16&#32;23:15:32><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-04-16">2023-04-16</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 约 2249 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 预计阅读 5 分钟</span>&nbsp;<span id="/lstm/" class="comment-visitors" data-flag-title="使用LSTM对航班延误进行预测">
              <i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="twikoo_visitors">-</span>&nbsp;次阅读
            </span>&nbsp;<span id="/lstm/" class="comment-count" data-flag-title="使用LSTM对航班延误进行预测">
              <i class="fa-regular fa-comments fa-fw" aria-hidden="true"></i>&nbsp;<span id="twikoo-comment-count">-</span>&nbsp;条评论
            </span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#介绍">介绍</a></li>
    <li><a href="#数据收集和预处理">数据收集和预处理</a></li>
    <li><a href="#lstm模型构建和训练">LSTM模型构建和训练</a></li>
    <li><a href="#模型预测和评估">模型预测和评估</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h1 id="使用lstm预测航班延误">使用LSTM预测航班延误</h1>
<h2 id="介绍">介绍</h2>
<p>航班延误是航空公司和乘客都不愿意面对的问题。在某些情况下，延误可能会导致航空公司的巨额损失，也会影响旅客的日常生活。因此，预测航班延误对于航空公司和旅客来说都非常重要。在本文中，我们将介绍如何使用LSTM来预测航班延误。</p>
<h2 id="数据收集和预处理">数据收集和预处理</h2>
<p>要预测航班延误，我们需要收集航班数据。我们可以从航空公司、机场网站或第三方数据提供商那里获取数据。在本文中，我们使用开放数据集“航班延误和取消数据”来预测航班延误。在收集数据后，我们需要对数据进行预处理。这包括清洗数据、处理缺失值和异常值等。我们还需要将数据转换为适合LSTM模型的形式。</p>
<p>这个是本文的例子中所用的数据集的来源：</p>
<h2 id="lstm模型构建和训练">LSTM模型构建和训练</h2>
<p>LSTM是一种适合于序列数据的深度学习模型，常用于时间序列预测。我们可以使用LSTM来预测航班延误。在构建LSTM模型之前，我们需要将数据集分为训练集和测试集。训练集用于训练模型，测试集用于评估模型的性能。在训练LSTM模型时，我们需要确定一些参数，如LSTM层数、神经元个数、迭代次数等。我们还需要选择合适的损失函数和优化器。在训练完模型后，我们可以使用测试集来评估模型的性能。</p>
<p>1.导入包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span><span class="p">,</span><span class="n">models</span><span class="p">,</span><span class="n">optimizers</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dropout</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span><span class="n">Dense</span><span class="p">,</span><span class="n">Flatten</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tensorflow.keras.losses</span> <span class="kn">import</span> <span class="n">MeanSquaredError</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">nvidia</span><span class="o">-</span><span class="n">smi</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s1">&#39;/kaggle/input&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;0&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Thu Apr 13 16:28:46 2023
</span></span><span class="line"><span class="cl">+-----------------------------------------------------------------------------+
</span></span><span class="line"><span class="cl">| NVIDIA-SMI 470.161.03   Driver Version: 470.161.03   CUDA Version: 11.4     |
</span></span><span class="line"><span class="cl">|-------------------------------+----------------------+----------------------+
</span></span><span class="line"><span class="cl">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span></span><span class="line"><span class="cl">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
</span></span><span class="line"><span class="cl">|                               |                      |               MIG M. |
</span></span><span class="line"><span class="cl">|===============================+======================+======================|
</span></span><span class="line"><span class="cl">|   0  Tesla P100-PCIE...  Off  | 00000000:00:04.0 Off |                    0 |
</span></span><span class="line"><span class="cl">| N/A   38C    P0    27W / 250W |      0MiB / 16280MiB |      0%      Default |
</span></span><span class="line"><span class="cl">|                               |                      |                  N/A |
</span></span><span class="line"><span class="cl">+-------------------------------+----------------------+----------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">+-----------------------------------------------------------------------------+
</span></span><span class="line"><span class="cl">| Processes:                                                                  |
</span></span><span class="line"><span class="cl">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
</span></span><span class="line"><span class="cl">|        ID   ID                                                   Usage      |
</span></span><span class="line"><span class="cl">|=============================================================================|
</span></span><span class="line"><span class="cl">|  No running processes found                                                 |
</span></span><span class="line"><span class="cl">+-----------------------------------------------------------------------------+
</span></span><span class="line"><span class="cl">/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv
</span></span><span class="line"><span class="cl">/kaggle/input/airlinedelay/Airline%20Delay.csv
</span></span><span class="line"><span class="cl">/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.导入数据集</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#导入数据集，分为大中小</span>
</span></span><span class="line"><span class="cl"><span class="c1"># df=pd.read_csv(&#39;/kaggle/input/us-flight-delay-from-january-2017-july-2022/Airline_Delay_Cause.csv&#39;)#mid</span>
</span></span><span class="line"><span class="cl"><span class="c1"># df=pd.read_csv(&#39;/kaggle/input/airline-delay-cause/Airline_Delay_Cause.csv&#39;)#big</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/kaggle/input/airlinedelay/Airline%20Delay.csv&#39;</span><span class="p">)</span><span class="c1">#small</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.进行简单的数据预处理，这里我使用了中位数进行对每个特征求出对应的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 首先通过 df[&#39;arr_cancelled&#39;]==0 这个条件筛选掉了所有 arr_cancelled 列中值为 1 的行，也就是已经取消的航班。</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_cancelled&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 然后将 carrier_ct、weather_ct、nas_ct、security_ct 和 late_aircraft_ct 这五列重新赋值，除以 arr_flights 列对应行的值，计算每种延误类型对总到达航班数的占比</span>
</span></span><span class="line"><span class="cl"><span class="n">arrivingFlights</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier_ct&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier_ct&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;weather_ct&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;weather_ct&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nas_ct&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nas_ct&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;security_ct&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;security_ct&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;late_aircraft_ct&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;late_aircraft_ct&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 接着，将 carrier_delay、weather_delay、security_delay 和 late_aircraft_delay 分别除以 arr_flights 对应行的值，计算每种延误类型对总延误时间的占比。</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier_delay&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier_delay&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;weather_delay&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;weather_delay&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;security_delay&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;security_delay&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;late_aircraft_delay&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;late_aircraft_delay&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 将 arr_delay 列除以 arr_flights 对应行的值，计算平均每个到达航班的延误时间。</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_delay&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_delay&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_flights&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 计算 arr_delay 列的标准差和均值，然后求出阈值（threshhold），这里将阈值设为平均值加两倍标准差。</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">mean</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">threshhold</span><span class="o">=</span><span class="n">mean</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">std</span>
</span></span><span class="line"><span class="cl"><span class="nb">filter</span><span class="o">=</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_delay&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">threshhold</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 最后根据阈值和 arr_delay 列的值进行筛选，将 arr_delay 列的值小于阈值的行保留，其余行删除，即剔除过度偏离平均水平的异常值，返回一个新的数据帧 df。</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="nb">filter</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 画图，延误的分钟，横坐标为时间序</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Carrier&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;weather_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Weather&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;security_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Security&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;late_aircraft_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Late&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;delay in minutes&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 从这里我们可以看到，大多数的延误时间在10-15分钟，所以使用这个来判断航班是否延误</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a class="lightgallery" href="https://s1.imagehub.cc/images/2023/07/25/__results___3_0.png" data-thumbnail="https://s1.imagehub.cc/images/2023/07/25/__results___3_0.png" data-sub-html="<h2>https://s1.imagehub.cc/images/2023/07/25/__results___3_0.png</h2>"><img loading="lazy" src="https://s1.imagehub.cc/images/2023/07/25/__results___3_0.png" srcset="https://s1.imagehub.cc/images/2023/07/25/__results___3_0.png, https://s1.imagehub.cc/images/2023/07/25/__results___3_0.png 1.5x, https://s1.imagehub.cc/images/2023/07/25/__results___3_0.png 2x" sizes="auto" data-title="https://s1.imagehub.cc/images/2023/07/25/__results___3_0.png" data-alt="https://s1.imagehub.cc/images/2023/07/25/__results___3_0.png" width="900px" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></a>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 差不多也是中位数</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier_ct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nas_ct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;security_ct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;late_aircraft_ct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a class="lightgallery" href="https://s1.imagehub.cc/images/2023/07/25/__results___4_0.png" data-thumbnail="https://s1.imagehub.cc/images/2023/07/25/__results___4_0.png" data-sub-html="<h2>https://s1.imagehub.cc/images/2023/07/25/__results___4_0.png</h2>"><img loading="lazy" src="https://s1.imagehub.cc/images/2023/07/25/__results___4_0.png" srcset="https://s1.imagehub.cc/images/2023/07/25/__results___4_0.png, https://s1.imagehub.cc/images/2023/07/25/__results___4_0.png 1.5x, https://s1.imagehub.cc/images/2023/07/25/__results___4_0.png 2x" sizes="auto" data-title="https://s1.imagehub.cc/images/2023/07/25/__results___4_0.png" data-alt="https://s1.imagehub.cc/images/2023/07/25/__results___4_0.png" width="900px" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></a>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 航空公司计数</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">carrier</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;carrier_name&#34;</span><span class="p">)[</span><span class="s1">&#39;carrier_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">][</span><span class="s2">&#34;carrier_name&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">carrier</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&#34;bar&#34;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Carrier Flight counts&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a class="lightgallery" href="https://s1.imagehub.cc/images/2023/07/25/__results___5_0.png" data-thumbnail="https://s1.imagehub.cc/images/2023/07/25/__results___5_0.png" data-sub-html="<h2>https://s1.imagehub.cc/images/2023/07/25/__results___5_0.png</h2>"><img loading="lazy" src="https://s1.imagehub.cc/images/2023/07/25/__results___5_0.png" srcset="https://s1.imagehub.cc/images/2023/07/25/__results___5_0.png, https://s1.imagehub.cc/images/2023/07/25/__results___5_0.png 1.5x, https://s1.imagehub.cc/images/2023/07/25/__results___5_0.png 2x" sizes="auto" data-title="https://s1.imagehub.cc/images/2023/07/25/__results___5_0.png" data-alt="https://s1.imagehub.cc/images/2023/07/25/__results___5_0.png" width="900px" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></a>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 机场计数</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">flights</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&#34;airport&#34;</span><span class="p">)[</span><span class="s1">&#39;airport&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">][</span><span class="s2">&#34;airport&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flights</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&#34;bar&#34;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Airport Flight counts&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a class="lightgallery" href="https://s1.imagehub.cc/images/2023/07/25/__results___6_0.png" data-thumbnail="https://s1.imagehub.cc/images/2023/07/25/__results___6_0.png" data-sub-html="<h2>https://s1.imagehub.cc/images/2023/07/25/__results___6_0.png</h2>"><img loading="lazy" src="https://s1.imagehub.cc/images/2023/07/25/__results___6_0.png" srcset="https://s1.imagehub.cc/images/2023/07/25/__results___6_0.png, https://s1.imagehub.cc/images/2023/07/25/__results___6_0.png 1.5x, https://s1.imagehub.cc/images/2023/07/25/__results___6_0.png 2x" sizes="auto" data-title="https://s1.imagehub.cc/images/2023/07/25/__results___6_0.png" data-alt="https://s1.imagehub.cc/images/2023/07/25/__results___6_0.png" width="900px" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></a>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">encoder</span><span class="o">=</span><span class="n">LabelEncoder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 删掉没有用的列</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;airport&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;airport&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="s2">&#34;airport_name&#34;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&#34;arr_del15&#34;</span><span class="p">,</span><span class="s2">&#34;arr_cancelled&#34;</span><span class="p">,</span><span class="s2">&#34;year&#34;</span><span class="p">,</span> <span class="s2">&#34;airport_name&#34;</span><span class="p">,</span><span class="s2">&#34;carrier_name&#34;</span><span class="p">,</span><span class="s2">&#34;nas_delay&#34;</span><span class="p">,],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 对数据进行二分处理，若某条数据中的延误时间大于 10 分钟，这一列对应的值被标记为 1，否则标记为 0。这样处理之后，这三列数据变成了二分类变量。</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">arr_delay_columns</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;arr_delay&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr_delay_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">late_aircraft_delay_columns</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;late_aircraft_delay&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">carrier_delay_columns</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;carrier_delay&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1"># 画图 可以看到延误的航班大约占30%</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;delay mean:&#34;</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;arr_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;late_aircraft_delay mean:&#34;</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;late_aircraft_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;late_aircraft_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;carrier_delay mean:&#34;</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;late_aircraft_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">late_aircraft_delay_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;carrier_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">carrier_delay_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;label&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">total</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&#34;label&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">percents</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="n">total</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">percents</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">percents</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> distribution&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;label&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">delay</span> <span class="n">mean</span><span class="p">:</span> <span class="mf">8.184618800493773</span> <span class="mf">28.467741935483872</span>
</span></span><span class="line"><span class="cl"><span class="n">late_aircraft_delay</span> <span class="n">mean</span><span class="p">:</span> <span class="mf">2.7714400135202206</span> <span class="mf">24.285714285714285</span>
</span></span><span class="line"><span class="cl"><span class="n">carrier_delay</span> <span class="n">mean</span><span class="p">:</span> <span class="mf">3.2955479971538186</span> <span class="mf">26.5</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a class="lightgallery" href="https://s1.imagehub.cc/images/2023/07/25/__results___7_1.png" data-thumbnail="https://s1.imagehub.cc/images/2023/07/25/__results___7_1.png" data-sub-html="<h2>https://s1.imagehub.cc/images/2023/07/25/__results___7_1.png</h2>"><img loading="lazy" src="https://s1.imagehub.cc/images/2023/07/25/__results___7_1.png" srcset="https://s1.imagehub.cc/images/2023/07/25/__results___7_1.png, https://s1.imagehub.cc/images/2023/07/25/__results___7_1.png 1.5x, https://s1.imagehub.cc/images/2023/07/25/__results___7_1.png 2x" sizes="auto" data-title="https://s1.imagehub.cc/images/2023/07/25/__results___7_1.png" data-alt="https://s1.imagehub.cc/images/2023/07/25/__results___7_1.png" width="900px" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></a>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 分割数据集，训练集和验证集</span>
</span></span><span class="line"><span class="cl"><span class="n">X_columns</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="ow">in</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;arr_delay&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">X</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">X_columns</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">X_columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.22</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;carrier&#39;</span><span class="p">,</span> <span class="s1">&#39;airport&#39;</span><span class="p">,</span> <span class="s1">&#39;arr_flights&#39;</span><span class="p">,</span> <span class="s1">&#39;carrier_ct&#39;</span><span class="p">,</span> <span class="s1">&#39;weather_ct&#39;</span><span class="p">,</span> <span class="s1">&#39;nas_ct&#39;</span><span class="p">,</span> <span class="s1">&#39;security_ct&#39;</span><span class="p">,</span> <span class="s1">&#39;late_aircraft_ct&#39;</span><span class="p">,</span> <span class="s1">&#39;arr_diverted&#39;</span><span class="p">,</span> <span class="s1">&#39;carrier_delay&#39;</span><span class="p">,</span> <span class="s1">&#39;weather_delay&#39;</span><span class="p">,</span> <span class="s1">&#39;security_delay&#39;</span><span class="p">,</span> <span class="s1">&#39;late_aircraft_delay&#39;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#建立LSTM模型</span>
</span></span><span class="line"><span class="cl"><span class="n">lookback</span><span class="o">=</span><span class="mi">6</span>
</span></span><span class="line"><span class="cl"><span class="n">n_features</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># inputs = layers.Input((lookback, n_features), dtype=&#34;float32&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=True)(inputs)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># x = layers.BatchNormalization()(x)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># x = layers.Dropout(0.25)(x)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># x = layers.LSTM(200, activation=&#39;tanh&#39;, return_sequences=False)(x)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># x = layers.BatchNormalization()(x)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># x = layers.Dropout(0.25)(x)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># x = layers.Dense(100, activation=&#39;relu&#39;)(x)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># outputs = layers.Dense(1, activation=&#39;sigmoid&#39;)(x)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">((</span><span class="n">lookback</span><span class="p">,</span> <span class="n">n_features</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&#34;float32&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lstm1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lstm2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">batch1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">dropout1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dense1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dense2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s2">&#34;sigmoid&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">lstm1</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">lstm2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">batch1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">dense1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">dropout1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">dense2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">outputs</span> <span class="o">=</span> <span class="n">output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#model = models.Model(inputs=inputs, outputs=outputs)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#loss=MeanSquaredError(reduction=&#34;auto&#34;, name=&#34;mean_squared_error&#34;),</span>
</span></span><span class="line"><span class="cl">    <span class="n">weighted_metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;acc&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">es</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&#34;val_loss&#34;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&#34;min&#34;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 转换数据格式，输入数据 X 和标签 y 分别转换为 np.array 格式，并使用 .astype(np.float32) 将数据类型转为浮点数类型。</span>
</span></span><span class="line"><span class="cl"><span class="n">X2_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">X2_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">X2_train</span><span class="p">,(</span><span class="n">X2_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lookback</span><span class="p">,</span><span class="n">X2_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">y2_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">X2_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">X2_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">X2_test</span><span class="p">,(</span><span class="n">X2_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lookback</span><span class="p">,</span><span class="n">X2_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">y2_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">path_to_file</span><span class="o">=</span><span class="s2">&#34;/kaggle/working/lstm3.h5&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">file_exists</span> <span class="o">=</span> <span class="n">exists</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="n">file_exists</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fit data</span>
</span></span><span class="line"><span class="cl"><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">X2_train</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">y2_train</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X2_test</span><span class="p">,</span> <span class="n">y2_test</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># verbose=0,</span>
</span></span><span class="line"><span class="cl">    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#callbacks=[es],</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">model</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 训练loss</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&#34;loss&#34;</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s2">&#34;Train Loss&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&#34;val_loss&#34;</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s2">&#34;Validation Loss&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Loss vs Epochs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&#34;Epochs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;Loss&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a class="lightgallery" href="https://s1.imagehub.cc/images/2023/07/25/__results___11_0.png" data-thumbnail="https://s1.imagehub.cc/images/2023/07/25/__results___11_0.png" data-sub-html="<h2>https://s1.imagehub.cc/images/2023/07/25/__results___11_0.png</h2>"><img loading="lazy" src="https://s1.imagehub.cc/images/2023/07/25/__results___11_0.png" srcset="https://s1.imagehub.cc/images/2023/07/25/__results___11_0.png, https://s1.imagehub.cc/images/2023/07/25/__results___11_0.png 1.5x, https://s1.imagehub.cc/images/2023/07/25/__results___11_0.png 2x" sizes="auto" data-title="https://s1.imagehub.cc/images/2023/07/25/__results___11_0.png" data-alt="https://s1.imagehub.cc/images/2023/07/25/__results___11_0.png" width="900px" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></a>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">y_pred</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X2_train</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_pred</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">&gt;</span><span class="mf">0.5</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y_pred</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>43/43 [==============================] - 1s 3ms/step</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">legend_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;Prediction&#34;</span><span class="p">,</span><span class="s2">&#34;Train&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;Blue&#34;</span><span class="p">,</span><span class="s2">&#34;Red&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">units</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">y</span><span class="o">&gt;</span><span class="mf">0.5</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_train</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span><span class="n">labels</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><a class="lightgallery" href="https://s1.imagehub.cc/images/2023/07/25/__results___13_1.png" data-thumbnail="https://s1.imagehub.cc/images/2023/07/25/__results___13_1.png" data-sub-html="<h2>https://s1.imagehub.cc/images/2023/07/25/__results___13_1.png</h2>"><img loading="lazy" src="https://s1.imagehub.cc/images/2023/07/25/__results___13_1.png" srcset="https://s1.imagehub.cc/images/2023/07/25/__results___13_1.png, https://s1.imagehub.cc/images/2023/07/25/__results___13_1.png 1.5x, https://s1.imagehub.cc/images/2023/07/25/__results___13_1.png 2x" sizes="auto" data-title="https://s1.imagehub.cc/images/2023/07/25/__results___13_1.png" data-alt="https://s1.imagehub.cc/images/2023/07/25/__results___13_1.png" width="900px" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></a>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">correct</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">predictions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">correct</span><span class="o">+=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">correct</span>
</span></span><span class="line"><span class="cl">           <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;accuracy: &#34;</span><span class="p">,</span><span class="n">accuracy</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">y</span><span class="o">&gt;</span><span class="mf">0.5</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_train</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">]))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>accuracy: 90.0</p>
<h2 id="模型预测和评估">模型预测和评估</h2>
<p>在模型训练完成后，我们可以使用该模型来预测航班延误。我们可以将实时数据输入到模型中，模型将输出延误的概率。我们还可以使用各种指标来评估模型的性能，如平均绝对误差、均方误差等。如果模型的性能不够好，我们可以尝试调整模型参数、增加训练数据等方法来提高模型性能。</p>
<h2 id="总结">总结</h2>
<p>本文介绍了如何使用LSTM来预测航班延误。我们需要收集和预处理数据，构建和训练LSTM模型，使用模型预测和评估模型性能。预测航班延误对于航空公司和旅客都非常重要，希望这篇文章能够帮助你了解如何使用LSTM来预测航班延误。</p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2023-04-16&#32;23:15:32>更新于 2023-04-16&nbsp;</span>
      </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/lstm/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://blog.579878700.xyz/lstm/" data-title="使用LSTM对航班延误进行预测" data-hashtags="机器学习,LSTM"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://blog.579878700.xyz/lstm/" data-hashtag="机器学习"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://blog.579878700.xyz/lstm/" data-title="使用LSTM对航班延误进行预测"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/' class="post-tag">机器学习</a><a href='/tags/lstm/' class="post-tag">LSTM</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/zkml/" class="post-nav-item" rel="prev" title="零知识机器学习（ZKML）简介"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>零知识机器学习（ZKML）简介</a>
      <a href="/lstm_2/" class="post-nav-item" rel="next" title="了解LSTM神经网络">了解LSTM神经网络<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="twikoo"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://twikoo.js.org/" rel="external nofollow noopener noreferrer">Twikoo</a>.
      </noscript></div></article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.111.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.18-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">
              <a href="/">waka</a></span></div><div class="footer-line statistics"></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/twikoo/twikoo.all.min.js" defer></script><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":true,"expired":false,"twikoo":{"commentCount":true,"el":"#twikoo","envId":"https://twikoo.579878700.xyz/","lang":"zh-cn"}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},"duration":6,"speed":100}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
